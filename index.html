<!DOCTYPE html>
<html lang="en" class="light"> <!-- Default to light mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Late Owner Process</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins for headings, Lato for body, Caveat for handwriting -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Lato:wght@400;700&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <!-- Three.js for 3D background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Custom Tailwind configuration for the new theme
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Lato', 'sans-serif'],
                        'heading': ['Poppins', 'sans-serif'],
                        'handwriting': ['Caveat', 'cursive'],
                    },
                    colors: {
                        // Light Mode Palette
                        'primary': '#5E56F8',
                        'primary-hover': '#4338ca',
                        'secondary': '#1A202C',
                        'secondary-hover': '#2D3748',
                        'background': '#F7F8FC',
                        'card': 'rgba(255, 255, 255, 0.8)', // Slightly transparent for glass effect
                        'text-primary': '#1A202C',
                        'text-secondary': '#718096',
                        'border': '#E2E8F0',
                        // Dark Mode Palette
                        'dark-primary': '#7F7AFF',
                        'dark-primary-hover': '#9592FF',
                        'dark-secondary': '#E2E8F0',
                        'dark-secondary-hover': '#F7FAFC',
                        'dark-background': '#121212',
                        'dark-card': 'rgba(26, 26, 26, 0.7)', // Slightly transparent for glass effect
                        'dark-text-primary': '#F7FAFC',
                        'dark-text-secondary': '#A0AEC0',
                        'dark-border': '#2D3748',
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles and dynamic effects */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px 0px rgba(94, 86, 248, 0.4); }
            50% { box-shadow: 0 0 30px 5px rgba(94, 86, 248, 0.6); }
        }
        .dark .logo-glow {
            animation-name: pulse-glow-dark;
        }
        @keyframes pulse-glow-dark {
            0%, 100% { box-shadow: 0 0 15px 0px rgba(127, 122, 255, 0.4); }
            50% { box-shadow: 0 0 30px 5px rgba(127, 122, 255, 0.6); }
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(125deg, #5E56F8, #D946EF, #FBBF24);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
            z-index: -2;
            opacity: 0.05;
        }
        .dark body::before {
            opacity: 0.1;
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        .form-input {
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            box-shadow: 0 0 0 2px var(--tw-ring-color);
            border-color: var(--tw-ring-color);
        }
        .btn-glow {
            position: relative;
            overflow: hidden;
        }
        .btn-glow:hover {
            box-shadow: 0 0 25px 0 rgba(94, 86, 248, 0.6);
        }
        .dark .btn-glow:hover {
            box-shadow: 0 0 25px 0 rgba(127, 122, 255, 0.6);
        }
        .glowing-line {
            height: 3px;
            width: 150px;
            background: linear-gradient(90deg, transparent, #5E56F8, #D946EF, #5E56F8, transparent);
            background-size: 200% 100%;
            animation: glow 4s linear infinite;
        }
        .dark .glowing-line {
             background: linear-gradient(90deg, transparent, #7F7AFF, #F472B6, #7F7AFF, transparent);
             background-size: 200% 100%;
        }
        .glass-card {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .logo-glow {
            border-radius: 9999px;
            animation: pulse-glow 4s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-background text-text-primary dark:bg-dark-background dark:text-dark-text-primary font-sans antialiased">

    <canvas id="bg-canvas"></canvas>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl relative z-10">
        
        <header class="relative flex flex-col justify-center items-center mb-8 sm:mb-12 animate-fadeInUp" style="animation-delay: 100ms;">
            <!-- Logo container: absolute on large screens, relative (stacked) on small screens -->
            <div class="logo-glow sm:absolute sm:top-0 sm:left-0 mb-4 sm:mb-0">
                <img src="https://i.ibb.co/TxmWmdRd/image.png" alt="Primary Logo" class="h-16 w-16">
            </div>
            <div class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold font-heading text-text-primary dark:text-dark-text-primary tracking-tight">
                    Late Owner Process
                </h1>
                <div class="glowing-line mt-3 mx-auto"></div>
            </div>
            <!-- Theme toggle button -->
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-text-secondary dark:text-dark-text-secondary hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-dark-primary">
                <svg id="theme-toggle-light-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-toggle-dark-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <main class="bg-card dark:bg-dark-card p-6 sm:p-10 rounded-2xl shadow-2xl glass-card animate-fadeInUp" style="animation-delay: 200ms;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 pb-8 border-b border-border dark:border-dark-border">
                <div>
                    <label for="vertical" class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary mb-2">Business Vertical</label>
                    <select id="vertical" class="w-full p-3 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-lg shadow-sm focus:ring-primary dark:focus:ring-dark-primary form-input">
                        <option>FV (Fast-moving)</option>
                        <option>NFV (Non-Fast-moving)</option>
                        <option>TMart</option>
                    </select>
                </div>
                <div>
                    <label for="riderReachable" class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary mb-2">Rider Status</label>
                    <select id="riderReachable" class="w-full p-3 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-lg shadow-sm focus:ring-primary dark:focus:ring-dark-primary form-input">
                        <option value="yes">Reachable</option>
                        <option value="no">Unreachable</option>
                    </select>
                </div>
            </div>

            <div id="ridersContainer" class="mb-6">
                <h2 class="text-xl font-bold font-heading text-text-primary dark:text-dark-text-primary mb-4">Rider Timestamps</h2>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-10">
                <button id="addRiderBtn" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 bg-secondary dark:bg-dark-secondary hover:bg-secondary-hover dark:hover:bg-dark-secondary-hover text-white dark:text-dark-background font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:-translate-y-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Rider
                </button>
                <button id="calculateBtn" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 bg-primary dark:bg-dark-primary hover:bg-primary-hover dark:hover:bg-dark-primary-hover text-white font-bold py-3 px-6 rounded-lg shadow-lg btn-glow transition-transform transform hover:-translate-y-1">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 00-1 1v1H2a2 2 0 00-2 2v9a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H5V3a1 1 0 00-1-1zM2 8v8h16V8H2z"></path></svg>
                    Calculate
                </button>
            </div>

            <div id="result" class="mt-12"></div>
        </main>

        <footer class="flex flex-col sm:flex-row items-center justify-between mt-10 text-center animate-fadeInUp" style="animation-delay: 300ms;">
            <div class="logo-glow">
                <img src="https://i.ibb.co/WvcTtbST/image.png" alt="Secondary Logo" class="h-10">
            </div>
            <div class="font-handwriting text-xl text-text-secondary dark:text-dark-text-secondary mt-4 sm:mt-0">
                <p>made with LOVE</p>
                <p>BY Omar Mohamed and Adham Mohamed</p>
            </div>
        </footer>
    </div>

    <div id="riderTemplate" class="hidden rider-card rider p-5 mb-4 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-xl relative animate-fadeInUp transition-all duration-300 hover:border-primary dark:hover:border-dark-primary hover:shadow-lg">
        <button class="remove-rider-btn absolute -top-3 -right-3 w-7 h-7 flex items-center justify-center bg-red-500 text-white rounded-full font-bold text-lg hover:bg-red-600 transform hover:scale-110 transition-transform" onclick="this.parentElement.remove()" title="Remove Rider">&times;</button>
        <h3 class="font-bold font-heading text-lg mb-4 text-primary dark:text-dark-primary">Rider</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Queued Time <input type="time" class="form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md queued focus:ring-primary dark:focus:ring-dark-primary"></label></div>
            <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Accepted Time <input type="time" class="form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md accepted focus:ring-primary dark:focus:ring-dark-primary"></label></div>
            <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Committed Pickup Time <input type="time" class="form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md committed focus:ring-primary dark:focus:ring-dark-primary"></label></div>
            <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Near Pickup Time <input type="time" class="form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md nearpickup focus:ring-primary dark:focus:ring-dark-primary"></label></div>
            <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Picked Up Time <input type="time" class="form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md pickedup focus:ring-primary dark:focus:ring-dark-primary"></label></div>
            <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Est. Dropoff Departure <input type="time" class="form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md dropoff focus:ring-primary dark:focus:ring-dark-primary"></label></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 3D BACKGROUND LOGIC ---
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({
                canvas: document.querySelector('#bg-canvas'),
                alpha: true
            });

            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.setZ(30);

            const shapes = [];

            function createShapes() {
                // Clear existing shapes
                shapes.forEach(s => scene.remove(s));
                shapes.length = 0;

                const isDark = document.documentElement.classList.contains('dark');
                const color = isDark ? 0x7F7AFF : 0x5E56F8;
                const material = new THREE.MeshBasicMaterial({ color: color, wireframe: true });

                const geometries = [
                    new THREE.BoxGeometry(5, 5, 5),
                    new THREE.TetrahedronGeometry(5),
                    new THREE.OctahedronGeometry(5),
                    new THREE.IcosahedronGeometry(5)
                ];

                for (let i = 0; i < 50; i++) {
                    const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                    const shape = new THREE.Mesh(geometry, material);

                    const [x, y, z] = Array(3).fill().map(() => THREE.MathUtils.randFloatSpread(100));
                    shape.position.set(x, y, z);

                    const [rx, ry, rz] = Array(3).fill().map(() => Math.random() * 0.01 - 0.005);
                    shape.userData.rotation = { x: rx, y: ry, z: rz };

                    shapes.push(shape);
                    scene.add(shape);
                }
            }

            function animate() {
                requestAnimationFrame(animate);
                shapes.forEach(shape => {
                    shape.rotation.x += shape.userData.rotation.x;
                    shape.rotation.y += shape.userData.rotation.y;
                });
                renderer.render(scene, camera);
            }

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            createShapes();
            animate();

            // --- THEME TOGGLE LOGIC ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                }
                // Recreate shapes with new theme color
                createShapes();
            };

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(currentTheme);
            
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            // --- APPLICATION LOGIC ---
            const addRiderBtn = document.getElementById('addRiderBtn');
            const calculateBtn = document.getElementById('calculateBtn');
            const ridersContainer = document.getElementById('ridersContainer');
            const riderTemplate = document.getElementById('riderTemplate');
            
            const addRider = () => {
                const newRider = riderTemplate.cloneNode(true);
                newRider.id = '';
                newRider.classList.remove('hidden');
                const riderCount = ridersContainer.querySelectorAll('.rider-card').length + 1;
                newRider.querySelector('h3').textContent = `Rider ${riderCount}`;
                ridersContainer.appendChild(newRider);
            };

            addRider();
            addRiderBtn.addEventListener('click', addRider);

            calculateBtn.addEventListener("click", () => {
                const riders = document.querySelectorAll(".rider:not(#riderTemplate)");
                let totalDispatchingTime = 0;
                let delays = [];
                let cancellationReason = "";
                let hasMultipleRiders = riders.length > 1;
                let firstRiderIssue = false;
                
                let timelineHTML = `<h5 class="text-xl font-bold font-heading mb-4 text-text-primary dark:text-dark-text-primary">Timeline:</h5>`;

                riders.forEach((rider, index) => {
                    const queued = rider.querySelector(".queued").value;
                    const accepted = rider.querySelector(".accepted").value;
                    const committed = rider.querySelector(".committed").value;
                    const nearpickup = rider.querySelector(".nearpickup").value;
                    const pickedup = rider.querySelector(".pickedup").value;
                    const dropoff = rider.querySelector(".dropoff").value;

                    timelineHTML += `<div class="bg-background dark:bg-dark-background border-l-4 border-primary dark:border-dark-primary rounded-r-lg p-4 mb-3">
                        <strong class="font-bold text-text-primary dark:text-dark-text-primary">Rider ${index + 1}:</strong><br>`;

                    if (queued) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Queued: ${queued}</span><br>`;
                    if (accepted) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Accepted: ${accepted}</span><br>`;
                    if (committed) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Committed Pickup: ${committed}</span><br>`;
                    if (nearpickup) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Near Pickup: ${nearpickup}</span><br>`;
                    if (pickedup) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Picked Up: ${pickedup}</span><br>`;
                    if (dropoff) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Est. Dropoff Departure: ${dropoff}</span><br>`;

                    if (queued && accepted) {
                        let dispatchTime = diffMinutes(queued, accepted);
                        totalDispatchingTime += dispatchTime;
                        timelineHTML += `<em class="font-semibold text-text-primary dark:text-dark-text-primary">Dispatching Time: ${dispatchTime} mins</em><br>`;
                    }

                    if (committed && pickedup) {
                        let d = diffMinutes(committed, pickedup);
                        if (d > 0) delays.push(d);
                        timelineHTML += `<em class="font-semibold text-text-primary dark:text-dark-text-primary">Delay (Committed → Picked Up): ${d} mins</em><br>`;
                    } else if (nearpickup && pickedup) {
                        let d = diffMinutes(nearpickup, pickedup);
                        if (d > 0) delays.push(d);
                        timelineHTML += `<em class="font-semibold text-text-primary dark:text-dark-text-primary">Delay (Near Pickup → Picked Up): ${d} mins</em><br>`;
                    }

                    if (dropoff && pickedup) {
                        let dropoffDelay = diffMinutes(pickedup, dropoff);
                        if (dropoffDelay > 0) {
                            delays.push(dropoffDelay);
                            timelineHTML += `<em class="font-semibold text-text-primary dark:text-dark-text-primary">Dropoff Delay: ${dropoffDelay} mins</em><br>`;
                        }
                    }

                    if (index === 0) {
                        if ((accepted && !pickedup) || (queued && !accepted)) {
                            firstRiderIssue = true;
                            timelineHTML += `<strong class="text-red-500 font-bold">Issue detected with Rider 1</strong><br>`;
                        }
                    }

                    timelineHTML += `</div>`;
                });

                let riderReachable = document.getElementById("riderReachable").value;
                let maxDelay = Math.max(totalDispatchingTime, ...(delays.length ? delays : [0]));

                if (hasMultipleRiders && firstRiderIssue) {
                    cancellationReason = "Order picked up/delivered by another rider";
                } else if (maxDelay === totalDispatchingTime && totalDispatchingTime > 0) {
                    cancellationReason = "Lack of Delivery Men";
                } else if (riderReachable === "yes" && delays.length > 0) {
                    cancellationReason = "Late Delivery";
                } else if (riderReachable === "no") {
                    cancellationReason = "Rider Unreachable";
                } else {
                    cancellationReason = "Preparation Delay";
                }

                let resultHTML = `<div class="border-t-2 border-border dark:border-dark-border pt-8 mt-8 animate-fadeInUp">` + timelineHTML;
                resultHTML += `<div class="mt-6 p-6 bg-background dark:bg-dark-background rounded-xl">
                                <h5 class="text-xl font-bold font-heading mb-3 text-text-primary dark:text-dark-text-primary">Summary:</h5>`;
                if (totalDispatchingTime > 0) {
                    resultHTML += `<p class="text-text-secondary dark:text-dark-text-secondary">Total Dispatching Time: <span class="font-bold text-text-primary dark:text-dark-text-primary">${totalDispatchingTime} mins</span></p>`;
                }
                if (delays.length > 0) {
                    resultHTML += `<p class="text-text-secondary dark:text-dark-text-secondary">Delays: <span class="font-bold text-text-primary dark:text-dark-text-primary">${delays.join(", ")} mins</span></p>`;
                }
                resultHTML += `<p class="font-heading font-extrabold mt-4 text-xl"><strong>Cancellation Reason:</strong> <span class="text-primary dark:text-dark-primary">${cancellationReason}</span></p></div></div>`;

                document.getElementById("result").innerHTML = resultHTML;
            });

            function diffMinutes(start, end) {
                if (!start || !end) return 0;
                const [sh, sm] = start.split(":").map(Number);
                const [eh, em] = end.split(":").map(Number);
                const startTotalMinutes = sh * 60 + sm;
                const endTotalMinutes = eh * 60 + em;
                if (endTotalMinutes < startTotalMinutes) {
                    return (endTotalMinutes + 24 * 60) - startTotalMinutes;
                }
                return endTotalMinutes - startTotalMinutes;
            }
        });
    </script>
</body>
</html>
