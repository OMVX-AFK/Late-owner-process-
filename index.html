<!DOCTYPE html>
<html lang="en" class="light"> <!-- Default to light mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Late Owner Process</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins for headings, Lato for body, Caveat for handwriting -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Lato:wght@400;700&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <!-- Three.js for 3D background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Custom Tailwind configuration for the new theme
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Lato', 'sans-serif'],
                        'heading': ['Poppins', 'sans-serif'],
                        'handwriting': ['Caveat', 'cursive'],
                    },
                    colors: {
                        // Light Mode Palette
                        'primary': '#5E56F8',
                        'primary-hover': '#4338ca',
                        'secondary': '#1A202C',
                        'secondary-hover': '#2D3748',
                        'background': '#F7F8FC',
                        'card': 'rgba(255, 255, 255, 0.8)', // Slightly transparent for glass effect
                        'text-primary': '#1A202C',
                        'text-secondary': '#718096',
                        'border': '#E2E8F0',
                        // Dark Mode Palette
                        'dark-primary': '#7F7AFF',
                        'dark-primary-hover': '#9592FF',
                        'dark-secondary': '#E2E8F0',
                        'dark-secondary-hover': '#F7FAFC',
                        'dark-background': '#121212',
                        'dark-card': 'rgba(26, 26, 26, 0.7)', // Slightly transparent for glass effect
                        'dark-text-primary': '#F7FAFC',
                        'dark-text-secondary': '#A0AEC0',
                        'dark-border': '#2D3748',
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles and dynamic effects */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes modal-scale-in {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px 0px rgba(94, 86, 248, 0.4); }
            50% { box-shadow: 0 0 30px 5px rgba(94, 86, 248, 0.6); }
        }
        .dark .logo-glow {
            animation-name: pulse-glow-dark;
        }
        @keyframes pulse-glow-dark {
            0%, 100% { box-shadow: 0 0 15px 0px rgba(127, 122, 255, 0.4); }
            50% { box-shadow: 0 0 30px 5px rgba(127, 122, 255, 0.6); }
        }
        /* Shake animation for invalid inputs */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(125deg, #5E56F8, #a855f7, #D946EF, #f472b6, #FBBF24, #4ade80);
            background-size: 1000% 1000%;
            animation: aurora 30s ease infinite;
            z-index: -2;
            opacity: 0.1;
        }
        .dark body::before {
            opacity: 0.15;
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        .modal-content {
             animation: modal-scale-in 0.3s ease-out forwards;
        }
        .form-input {
            transition: all 0.2s ease-in-out;
        }
        .form-input.invalid {
            border-color: #ef4444 !important;
            box-shadow: 0 0 10px 2px rgba(239, 68, 68, 0.5) !important;
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
        .btn-glow {
            position: relative;
            overflow: hidden;
        }
        .btn-glow:hover {
            box-shadow: 0 0 25px 0 rgba(94, 86, 248, 0.6);
        }
        .dark .btn-glow:hover {
            box-shadow: 0 0 25px 0 rgba(127, 122, 255, 0.6);
        }
        .glowing-line {
            height: 3px;
            width: 150px;
            background: linear-gradient(90deg, transparent, #5E56F8, #D946EF, #5E56F8, transparent);
            background-size: 200% 100%;
            animation: glow 4s linear infinite;
        }
        .dark .glowing-line {
             background: linear-gradient(90deg, transparent, #7F7AFF, #F472B6, #7F7AFF, transparent);
             background-size: 200% 100%;
        }
        .glass-card {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .logo-glow {
            border-radius: 9999px;
            animation: pulse-glow 4s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-background text-text-primary dark:bg-dark-background dark:text-dark-text-primary font-sans antialiased">

    <canvas id="bg-canvas"></canvas>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl relative z-10">
        
        <header class="relative flex flex-col justify-center items-center mb-8 sm:mb-12 animate-fadeInUp" style="animation-delay: 100ms;">
            <div class="logo-glow sm:absolute sm:top-0 sm:left-0 mb-4 sm:mb-0">
                <img src="https://i.ibb.co/TxmWmdRd/image.png" alt="Primary Logo" class="h-16 w-16">
            </div>
            <div class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold font-heading text-text-primary dark:text-dark-text-primary tracking-tight">
                    Late Owner Process
                </h1>
                <div class="glowing-line mt-3 mx-auto"></div>
            </div>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-text-secondary dark:text-dark-text-secondary hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-dark-primary transition-transform duration-300">
                <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-toggle-dark-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <main class="bg-card dark:bg-dark-card p-6 sm:p-10 rounded-2xl shadow-2xl glass-card animate-fadeInUp" style="animation-delay: 200ms;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 pb-8 border-b border-border dark:border-dark-border">
                <div>
                    <label for="vertical" class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary mb-2">Business Vertical</label>
                    <select id="vertical" class="w-full p-3 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-lg shadow-sm focus:ring-primary dark:focus:ring-dark-primary form-input">
                        <option>FV</option> <option>NFV</option> <option>TMart</option>
                    </select>
                </div>
                <div>
                    <label for="riderReachable" class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary mb-2">Rider Status</label>
                    <select id="riderReachable" class="w-full p-3 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-lg shadow-sm focus:ring-primary dark:focus:ring-dark-primary form-input">
                        <option value="yes">Reachable</option> <option value="no">Unreachable</option>
                    </select>
                </div>
                 <div>
                    <label for="currentTime" class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary mb-2">Current Time</label>
                    <input type="text" id="currentTime" placeholder="0:00 AM/PM" class="form-input w-full p-3 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-lg shadow-sm focus:ring-primary dark:focus:ring-dark-primary time-input">
                </div>
            </div>

            <div id="ridersContainer" class="mb-6">
                <h2 class="text-xl font-bold font-heading text-text-primary dark:text-dark-text-primary mb-4">Rider Timestamps</h2>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-10">
                <button id="addRiderBtn" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 bg-secondary dark:bg-dark-secondary hover:bg-secondary-hover dark:hover:bg-dark-secondary-hover text-white dark:text-dark-background font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:-translate-y-1 active:translate-y-0">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Rider
                </button>
                <button id="calculateBtn" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 bg-primary dark:bg-dark-primary hover:bg-primary-hover dark:hover:bg-dark-primary-hover text-white font-bold py-3 px-6 rounded-lg shadow-lg btn-glow transition-transform transform hover:-translate-y-1 active:translate-y-0">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a1 1 0 00-1 1v1H2a2 2 0 00-2 2v9a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H5V3a1 1 0 00-1-1zM2 8v8h16V8H2z"></path></svg>
                    Analyze Reason
                </button>
            </div>

            <div id="result" class="mt-12"></div>
        </main>

        <footer class="flex flex-col sm:flex-row items-center justify-between mt-10 text-center animate-fadeInUp" style="animation-delay: 300ms;">
            <div class="logo-glow">
                <img src="https://i.ibb.co/WvcTtbST/image.png" alt="Secondary Logo" class="h-10">
            </div>
            <div class="font-handwriting text-xl text-text-secondary dark:text-dark-text-secondary mt-4 sm:mt-0">
                <p>made with LOVE</p>
                <p>BY Omar Mohamed and Adham Mohamed</p>
            </div>
        </footer>
    </div>

    <!-- Hidden Rider Template -->
    <div id="riderTemplate" class="hidden">
        <div class="rider-card rider p-5 mb-4 bg-background dark:bg-dark-background border-2 border-border dark:border-dark-border rounded-xl relative animate-fadeInUp transition-all duration-300 hover:border-primary dark:hover:border-dark-primary hover:shadow-lg hover:-translate-y-1">
            <button class="remove-rider-btn absolute -top-3 -right-3 w-7 h-7 flex items-center justify-center bg-red-500 text-white rounded-full font-bold text-lg hover:bg-red-600 transform hover:scale-110 transition-transform" title="Remove Rider">&times;</button>
            <h3 class="font-bold font-heading text-lg mb-4 text-primary dark:text-dark-primary">Rider</h3>
            <div class="rider-fields grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Queued Time <input type="text" placeholder="0:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md queued"></label></div>
                <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Accepted Time <input type="text" placeholder="0:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md accepted"></label></div>
                <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Committed Pickup <input type="text" placeholder="00:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md committed"></label></div>
                <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Near Pickup <input type="text" placeholder="0:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md nearpickup"></label></div>
                <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Picked Up <input type="text" placeholder="0:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md pickedup"></label></div>
                <div><label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Est. Dropoff <input type="text" placeholder="00:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md dropoff"></label></div>
            </div>
        </div>
    </div>
    
    <!-- Cancellation Reason Modal -->
    <div id="reasonModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="modal-content bg-card dark:bg-dark-card p-8 rounded-2xl shadow-2xl glass-card w-full max-w-md text-center">
            <h2 class="text-2xl font-extrabold font-heading text-text-primary dark:text-dark-text-primary mb-2">Cancellation Reason</h2>
            <div class="glowing-line mt-2 mb-6 mx-auto"></div>
            <p id="modalReasonText" class="text-xl font-bold text-primary dark:text-dark-primary mb-8"></p>
            <button id="closeReasonModalBtn" class="w-full bg-secondary dark:bg-dark-secondary hover:bg-secondary-hover dark:hover:bg-dark-secondary-hover text-white dark:text-dark-background font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:-translate-y-1 active:translate-y-0">
                Close
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 3D BACKGROUND LOGIC (UNCHANGED) ---
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({
                canvas: document.querySelector('#bg-canvas'),
                alpha: true
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.position.setZ(30);
            const shapes = [];
            function createShapes() {
                shapes.forEach(s => scene.remove(s));
                shapes.length = 0;
                const isDark = document.documentElement.classList.contains('dark');
                const color = isDark ? 0x7F7AFF : 0x5E56F8;
                const material = new THREE.MeshBasicMaterial({ color: color, wireframe: true });
                const geometries = [ new THREE.BoxGeometry(5, 5, 5), new THREE.TetrahedronGeometry(5), new THREE.OctahedronGeometry(5), new THREE.IcosahedronGeometry(5) ];
                for (let i = 0; i < 50; i++) {
                    const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                    const shape = new THREE.Mesh(geometry, material);
                    const [x, y, z] = Array(3).fill().map(() => THREE.MathUtils.randFloatSpread(100));
                    shape.position.set(x, y, z);
                    const [rx, ry, rz] = Array(3).fill().map(() => Math.random() * 0.01 - 0.005);
                    shape.userData.rotation = { x: rx, y: ry, z: rz };
                    shapes.push(shape);
                    scene.add(shape);
                }
            }
            function animate() {
                requestAnimationFrame(animate);
                shapes.forEach(shape => {
                    shape.rotation.x += shape.userData.rotation.x;
                    shape.rotation.y += shape.userData.rotation.y;
                });
                renderer.render(scene, camera);
            }
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            createShapes();
            animate();

            // --- THEME TOGGLE LOGIC (UNCHANGED) ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                }
                createShapes();
            };
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(currentTheme);
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
                themeToggleBtn.style.transform = `rotate(${newTheme === 'dark' ? 180 : 0}deg)`;
            });

            // --- APPLICATION LOGIC (REVERTED TO PURE JS LOGIC) ---
            const addRiderBtn = document.getElementById('addRiderBtn');
            const calculateBtn = document.getElementById('calculateBtn');
            const ridersContainer = document.getElementById('ridersContainer');
            const riderTemplate = document.getElementById('riderTemplate');
            const resultDiv = document.getElementById('result');
            const reasonModal = document.getElementById('reasonModal');
            const modalReasonText = document.getElementById('modalReasonText');
            const closeReasonModalBtn = document.getElementById('closeReasonModalBtn');
            const verticalSelect = document.getElementById('vertical');

            closeReasonModalBtn.addEventListener('click', () => reasonModal.classList.add('hidden'));
            
            // --- TIME PARSING AND CALCULATION FUNCTIONS ---
            function parseTime(timeStr) {
                if (!timeStr) return null;
                let parts = timeStr.trim().split(" ");
                let timePart = parts[0];
                let ampm = parts[1] ? parts[1].toUpperCase() : null;
                let [h, m, s] = timePart.split(":").map(Number);
                if (isNaN(s)) s = 0;
                if (ampm === "PM" && h < 12) h += 12;
                if (ampm === "AM" && h === 12) h = 0;
                return h * 60 + m + (s / 60);
            }

            function diffMinutes(start, end) {
                let startMinutes = parseTime(start);
                let endMinutes = parseTime(end);
                if (startMinutes == null || endMinutes == null || isNaN(startMinutes) || isNaN(endMinutes)) return 0;
                if (endMinutes < startMinutes) endMinutes += 24 * 60; // Handle overnight
                return Math.round(endMinutes - startMinutes);
            }

            // --- VALIDATION ---
            function validateAllInputs() {
                let allValid = true;
                document.querySelectorAll('.time-input').forEach(input => {
                    const parsed = parseTime(input.value);
                    if (input.value.trim() !== '' && (parsed === null || isNaN(parsed))) {
                        input.classList.add('invalid');
                        allValid = false;
                    } else {
                        input.classList.remove('invalid');
                    }
                });
                return allValid;
            }

            const validateSingleInput = (e) => {
                 const parsed = parseTime(e.target.value);
                 if (e.target.value.trim() !== '' && (parsed === null || isNaN(parsed))) {
                    e.target.classList.add('invalid');
                } else {
                    e.target.classList.remove('invalid');
                }
            }
            
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('input', validateSingleInput);
            });

            // --- EVENT LISTENERS ---
            const addRider = () => {
                const newRiderNode = riderTemplate.firstElementChild.cloneNode(true);
                const riderCount = ridersContainer.querySelectorAll('.rider-card').length + 1;
                newRiderNode.querySelector('h3').textContent = `Rider ${riderCount}`;

                const vertical = verticalSelect.value;
                if (vertical === "NFV" && riderCount === 1) {
                    const scheduledField = document.createElement('div');
                    scheduledField.innerHTML = `<label class="block text-sm font-bold text-text-secondary dark:text-dark-text-secondary">Scheduled Time <input type="text" placeholder="0:00 AM/PM" class="time-input form-input w-full mt-1 p-2 bg-card dark:bg-dark-card border-2 border-border dark:border-dark-border rounded-md scheduled"></label>`;
                    const fieldsContainer = newRiderNode.querySelector('.rider-fields');
                    fieldsContainer.insertBefore(scheduledField, fieldsContainer.firstChild);
                }

                newRiderNode.querySelector('.remove-rider-btn').addEventListener('click', () => {
                    newRiderNode.remove();
                    ridersContainer.querySelectorAll('.rider-card').forEach((card, index) => {
                        card.querySelector('h3').textContent = `Rider ${index + 1}`;
                    });
                });
                
                newRiderNode.querySelectorAll('.time-input').forEach(input => {
                    input.addEventListener('input', validateSingleInput);
                });
                ridersContainer.appendChild(newRiderNode);
            };

            addRider(); 
            addRiderBtn.addEventListener('click', addRider);
            
            verticalSelect.addEventListener('change', () => {
                ridersContainer.innerHTML = `<h2 class="text-xl font-bold font-heading text-text-primary dark:text-dark-text-primary mb-4">Rider Timestamps</h2>`;
                addRider();
            });
            
            // --- NEW DETERMINISTIC CALCULATION LOGIC BASED ON PDF ---
            function getCancellationReason(ridersData, riderReachable, vertical, currentTime) {
                const BUFFER_TIME = 10;
                
                const activeRiders = ridersData.filter(r => r.queued || r.accepted || r.committed || r.pickedup);

                if (activeRiders.length === 0) {
                    return { reason: "Not enough data", explanation: "" };
                }

                // Rule 1: Multi-Rider Issue
                if (activeRiders.length > 1) {
                    for (let i = 0; i < activeRiders.length - 1; i++) {
                        const rider = activeRiders[i];
                        if (rider.accepted && !rider.pickedup) {
                            return { 
                                reason: "Order picked up/delivered by another rider", 
                                explanation: `The issue originated with Rider ${i+1}, who was unassigned.` 
                            };
                        }
                    }
                }

                // Rule 2: Rider Unreachable
                if (riderReachable === 'no') {
                    return { 
                        reason: "Rider Unreachable", 
                        explanation: "The rider was marked as unreachable." 
                    };
                }

                // Rule 3: Delay Analysis
                let totalDispatchingDelay = 0;
                let totalPreparationDelay = 0;
                let totalRiderDelay = 0;

                activeRiders.forEach((rider, index) => {
                    // A. Long Dispatching -> Lack of Delivery Men
                    if (rider.queued && rider.accepted) {
                        totalDispatchingDelay += diffMinutes(rider.queued, rider.accepted);
                    }
                    
                    // B. Preparation Delay
                    // B1. NFV Scheduled
                    if (vertical === 'NFV' && index === 0 && rider.scheduled && rider.queued) {
                        totalPreparationDelay += diffMinutes(rider.scheduled, rider.queued);
                    }
                    // B2. Rider waiting at restaurant for food
                    if (rider.pickedup && (rider.nearpickup || rider.committed)) {
                        const arrivalTime = rider.nearpickup || rider.committed;
                        totalPreparationDelay += diffMinutes(arrivalTime, rider.pickedup);
                    }

                    // C. Rider Delay
                    // C1. Rider is late to Pick Up
                    if (rider.committed && rider.nearpickup) {
                        const committedMinutes = parseTime(rider.committed);
                        const nearPickupMinutes = parseTime(rider.nearpickup);
                        if (nearPickupMinutes > committedMinutes) {
                            totalRiderDelay += diffMinutes(rider.committed, rider.nearpickup);
                        }
                    }
                    // C2. Rider is late to Drop Off (only for the last rider)
                    if (index === activeRiders.length - 1 && rider.pickedup && rider.dropoff && currentTime) {
                        const dropoffMinutes = parseTime(rider.dropoff);
                        const currentMinutes = parseTime(currentTime);
                        if (currentMinutes > dropoffMinutes) {
                            totalRiderDelay += diffMinutes(rider.dropoff, currentTime);
                        }
                    }
                });

                const adjustedDispatching = Math.max(0, totalDispatchingDelay - BUFFER_TIME);
                const adjustedPreparation = Math.max(0, totalPreparationDelay - BUFFER_TIME);
                const adjustedRider = Math.max(0, totalRiderDelay - BUFFER_TIME);

                const delays = {
                    "Lack of Delivery Men": adjustedDispatching,
                    "Late Delivery": adjustedRider,
                    "Preparation Delay": adjustedPreparation
                };

                let maxDelay = 0; 
                let reason = "Preparation Delay";
                
                // Priority check based on the PDF
                if (delays["Lack of Delivery Men"] > maxDelay) {
                    maxDelay = delays["Lack of Delivery Men"];
                    reason = "Lack of Delivery Men";
                }
                 if (delays["Late Delivery"] > maxDelay) {
                    maxDelay = delays["Late Delivery"];
                    reason = "Late Delivery";
                }
                if (delays["Preparation Delay"] > maxDelay) {
                    maxDelay = delays["Preparation Delay"];
                    reason = "Preparation Delay";
                }
                
                let explanation = `The highest delay was for ${reason} with a total of ${Math.round(maxDelay)} minutes after the buffer time.`;
                if (maxDelay <= 0) {
                    explanation = "No significant delays were found outside the 10-minute buffer time.";
                }

                return { reason, explanation };
            }


            calculateBtn.addEventListener("click", () => {
                resultDiv.innerHTML = '';
                if (!validateAllInputs()) {
                    resultDiv.innerHTML = `<div class="p-4 text-red-700 bg-red-100 border-l-4 border-red-500 rounded-r-lg animate-fadeInUp"><p class="font-bold">Validation Error</p><p>Please correct the highlighted time formats (e.g., 5:30 PM).</p></div>`;
                    return;
                }

                const vertical = verticalSelect.value;
                const riders = document.querySelectorAll(".rider-card");
                const riderReachable = document.getElementById("riderReachable").value;
                const currentTimeInput = document.getElementById("currentTime").value;
                
                let timelineData = [];
                let timelineHTML = "";

                riders.forEach((rider, index) => {
                    const riderData = {
                        rider: `Rider ${index + 1}`,
                        queued: rider.querySelector(".queued").value.trim(),
                        accepted: rider.querySelector(".accepted").value.trim(),
                        committed: rider.querySelector(".committed").value.trim(),
                        nearpickup: rider.querySelector(".nearpickup").value.trim(),
                        pickedup: rider.querySelector(".pickedup").value.trim(),
                        dropoff: rider.querySelector(".dropoff").value.trim(),
                        scheduled: (vertical === "NFV" && index === 0) ? rider.querySelector(".scheduled")?.value.trim() : null
                    };
                    timelineData.push(riderData);

                    // Build the visual timeline simultaneously
                    if(riderData.queued || riderData.accepted || riderData.committed) {
                        timelineHTML += `<div class="bg-background dark:bg-dark-background border-l-4 border-primary dark:border-dark-primary rounded-r-lg p-4 mb-3 animate-fadeInUp" style="animation-delay: ${index * 100}ms">
                            <strong class="font-bold text-text-primary dark:text-dark-text-primary">Rider ${index + 1}:</strong><br>`;
                        if (riderData.scheduled) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Scheduled: ${riderData.scheduled}</span><br>`;
                        if (riderData.queued) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Queued: ${riderData.queued}</span><br>`;
                        if (riderData.accepted) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Accepted: ${riderData.accepted}</span><br>`;
                        if (riderData.committed) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Committed Pickup: ${riderData.committed}</span><br>`;
                        if (riderData.nearpickup) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Near Pickup: ${riderData.nearpickup}</span><br>`;
                        if (riderData.pickedup) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Picked Up: ${riderData.pickedup}</span><br>`;
                        if (riderData.dropoff) timelineHTML += `<span class="text-text-secondary dark:text-dark-text-secondary">Est. Dropoff Departure: ${riderData.dropoff}</span><br>`;
                        timelineHTML += `</div>`;
                    }
                });

                const analysisResult = getCancellationReason(timelineData, riderReachable, vertical, currentTimeInput);
                const cancellationReason = analysisResult.reason;
                const explanation = analysisResult.explanation;

                // --- DISPLAY RESULTS ---
                let summaryHTML = `<div class="mt-6 p-6 bg-background dark:bg-dark-background rounded-xl animate-fadeInUp">
                    <h5 class="text-xl font-bold font-heading mb-3 text-text-primary dark:text-dark-text-primary">Analysis Complete:</h5>
                    <p class="font-heading font-extrabold mt-4 text-xl">
                        <strong class="text-red-500 dark:text-red-400">Cancellation Reason:</strong> 
                        <span id="reasonText" class="text-primary dark:text-dark-primary">${cancellationReason.trim()}</span>
                    </p>
                    <p class="text-sm text-text-secondary dark:text-dark-text-secondary mt-2">${explanation}</p>
                </div>`;

                resultDiv.innerHTML = `<div class="border-t-2 border-border dark:border-dark-border pt-8 mt-8 animate-fadeInUp">
                    <h5 class="text-xl font-bold font-heading mb-4 text-text-primary dark:text-dark-text-primary">Timeline:</h5>
                    ${timelineHTML}
                    ${summaryHTML}
                </div>`;
                
                modalReasonText.textContent = cancellationReason.trim();
                reasonModal.classList.remove('hidden');
            });
        });
    </script>
</body>
</html>
